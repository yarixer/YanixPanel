datasource db {
  provider = "mysql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              BigInt   @id @default(autoincrement())
  email           String   @unique
  passwordHash    String
  isAdmin         Boolean  @default(false)
  verified        Boolean  @default(false)
  registrationIp  String?
  sessions        Session[]
  containerAccess RestrictedContainerAccess[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Session {
  id               BigInt  @id @default(autoincrement())
  user             User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           BigInt
  sessionTokenHash String  @unique
  refreshTokenHash String  @unique
  ip               String
  userAgent        String?
  isActive         Boolean @default(true)
  expiresAt        DateTime
  refreshExpiresAt DateTime

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model YanixServer {
  id         Int      @id @default(autoincrement())
  hostLabel  String   @unique
  ip         String
  apiBaseUrl String
  natsUrl    String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model RestrictedContainer {
  containerId String  @id
  access      RestrictedContainerAccess[]
}

model RestrictedContainerAccess {
  containerId String
  userId      BigInt

  container   RestrictedContainer @relation(fields: [containerId], references: [containerId], onDelete: Cascade)
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([containerId, userId])
  @@index([userId, containerId], name: "idx_user_container")
}

model CommandPattern {
  id      Int    @id @default(autoincrement())
  name    String @unique
  pattern Json

  bindings ContainerCommandPatternBinding[]
}

model ContainerCommandPatternBinding {
  containerId String @id
  patternName String

  commandPattern CommandPattern @relation(fields: [patternName], references: [name], onDelete: Cascade)
}
